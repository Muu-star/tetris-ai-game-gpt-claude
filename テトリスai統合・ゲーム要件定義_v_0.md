# テトリスAI統合・ゲーム要件定義 v0.9（詳細化ドラフト）

> 本書は、既存の草案を基に、AIゴーストを備えたシングルプレイ用テトリスゲームの要件を詳細化したものです。AIコーディングエージェント（Cursor / Claude Code 等）を前提に、未経験者でも実装を進められる構成・受け入れ条件・テスト観点まで落とし込みます。

---

## A. 背景と目的
- 目的：自作テトリスゲームに、**学習済みAIの助言（次の一手）をAIゴーストとして重ね描画**し、プレイヤーの意思決定訓練を支援する。
- スコアKPIは **5分（300秒）間の擬似火力合計**。**RENとPCはKPI算入外**（ログは任意で残す）。
- コントローラは **キーボードのみ**。**キーコンフィグ（リバインド）必須**。リプレイ・記録は不要（開発時のデバッグログのみ任意）。

---

## B. スコープ
- **対象**：Webブラウザで動作するシングルプレイテトリス（60fps目安）。
- **非対象**：対戦・ネットワーク同期・ランキング配信・リプレイ保存（将来検討可）。

---

## C. ゲームルール／物理仕様（PPT2 近似）
> 値は調整可能。調整用の `config.json` で一元管理し、実行時に読み込む。

### C-1. フィールド・ランダマイザ
- フィールド：10×20（上部に隠し行最大2〜4を内部保持）。
- ランダマイザ：**7-bag**、バッグ境界は Next へ連続供給。
- RNG：**seed 指定可能**（再現性の担保）。AIとゲームエンジンで同一seedを共有。
- **シード・ハンドシェイク**：ゲーム開始時に`seed`と`bagIndex`をAIへ送付し、以後は**バッグ進行をイベント駆動で同期**（ロック・HOLDでの消費も一致させる）。

### C-2. ピース定義・回転系（SRS）
- ピース：I, O, T, S, Z, J, L。
- スポーン：各ピースの規定スポーン位置・向き（上部に重なればゲームオーバー）。
- 回転：**ガイドラインSRS**、**180°回転なし**。公式キック表を実装。
- **T-Spin 判定**：PPT2準拠のガイドライン方式（角当たり・最終動作＝回転）。Mini/正規の区別はPPT2準拠。将来差異が出た場合は`tsMiniRuleset`で切替。
- ホールド：**1手につき1回のみ**、連続ホールド不可。ホールド取り出しは **初期向き**。

### C-3. 落下・移動・ロック
- 自然落下（gravity）：**5.0 cells/s 目安**（PPT2 Level 3 近似）。
- ソフトドロップ：重力×**20倍**（固定値、調整可）。
- ハードドロップ：**即ロック**（ロック遅延は発生しない）。
- 横移動：DAS/ARR 方式。
  - **DAS**：**133ms**（初期ホールド時間、調整可）。
  - **ARR**：**10ms**（到達までのリピート間隔、調整可）。
- ロック遅延：**500ms**、**Move Reset**、**リセット上限15回**（15回目で強制ロック）。
  - リセットトリガ：**左右移動・回転のみ**（ソフトドロップはカウントしない）。
- ラインクリア遅延：**50ms**（初期値、実装中に調整）。
- ARE：**0ms**（ラインクリア後の次ピース投入待ち無し）。

### C-4. スコア／KPI
- KPI 参照表：
  - Single: 0 / Double: 1 / Triple: 2 / Tetris: 4
  - T-Spin Mini Single: 1 / T-Spin Single: 2 / T-Spin Double: 4 / T-Spin Triple: 6
  - **B2Bボーナス**：B2B対象（Tetris／T-Spin Single／T-Spin Double／T-Spin Triple／**T-Spin Mini Single**）の**連続時 +1**（`b2bCountMini`でMini除外に切替可能）
  - **Perfect Clear**：0（**除外**）
  - **Combo/REN**：0（**除外**）
- KPI集計：**300秒ウィンドウ**の合計点。
- B2B継続判定：直前が B2B 対象で次も対象なら継続。

---

## D. 入力とキーコンフィグ
- 既定割当（例）：
  - 左右移動：`←` / `→`
  - ソフトドロップ：`↓`
  - ハードドロップ：`Space`
  - 左回転：`Z`、右回転：`X`、180°回転：**未実装**
  - ホールド：`C`
- コンフィグ要件：
  - UI で任意キーへリバインド（重複割り当ての検出・警告）。
  - 設定は `localStorage` に保存／復元、リセット機能あり。
  - **DAS/ARR/ソフトドロップ倍率も UI から変更可能（±50% の範囲）**。キーコンフィグ画面に統合。

### D-1. ゲーム進行とKPI計測
- **Start → 3秒カウントダウン → 操作開始**。
- そこから **300秒（5分）** をカウントダウン。
- **Pauseは無し**。**Reset** または **Quit** のみ。 

## E. 画面UI
- プレイフィールド（グリッド描画、ゴースト可視化のON/OFF）。
- Next 5、Hold 1枠表示。
- **AIゴースト**：プレイヤーゴーストとは別レイヤで描画。
  - 座標系：**左上原点・セル単位**でプレイヤーと完全一致（オフセット=0,0）。
  - 視認性：半透明 / 枠線 / 色差で区別（設定で切替可能）。
- KPI と経過時間（300秒カウントダウン）を HUD 表示。

### E-1. 座標系とレンダリング規約（厳密定義）
- **グリッド**：列=10, 行=20（隠し行2〜4は描画外）。原点は盤面の**左上（x=0,y=0）**。
- **単位**：1セル=1ロジック単位。描画は `tileSize` [px] を整数で定義し、`px(x,y)=(boardOriginX + x*tileSize, boardOriginY + y*tileSize)` の**同一変換関数**をプレイヤー/AI/ゴーストの全レイヤで共有。
- **スナップ**：小数座標は使用しない。Canvas の実ピクセル比（devicePixelRatio）は**バックバッファ拡大**で吸収し、**論理座標は整数**を保つ。
- **回転中心**：SRSの回転中心（I/O/T/S/Z/J/L 固有）を**ロジック座標**で定義し、同値を描画にも使用（別系で再計算しない）。
- **スポーン**：全ピースの初期 (x,y,rot) を**ロジック定数**として一箇所に集約（`srs.ts`）。
- **境界**：外周は当たり判定のみ。描画時の外枠線は**+0px**で、内部セルと同一変換を適用。
- **テスト**：`coords.e2e.ts` にて (1) 同一マスのプレイヤーとAIゴーストのピクセル座標が**完全一致**、(2) tileSize を変更しても差分ゼロ、(3) boardOrigin を変更しても差分ゼロ、を確認。

## F. AI 仕様（探索・評価・I/F）

### F-1. 概要
- 目的：**「現在の手」の最良手（必要ならホールド）**を提示して AI ゴーストに反映。
- ターン単位で探索を行い、**1手あたり 10〜16ms** を上限に打切り（調整可）。

### F-2. 探索
- 候補生成：現状の操作系（SRS・キック）で **到達可能な全着地点**を列挙（重複除去）。
- ビームサーチ：**幅 N=200、深さ d=2〜3** を初期値。時間予算で早期停止。
- ホールド分岐：**現ピースの最初の意思決定でのみ**「使う／使わない」の2枝を作成。

### F-3. 評価関数
- KPIの**期待増分**（直近の配置で得られるスコア）＋**盤面健全性**の重み付き合算：
  - 穴（空隙）数、被覆穴数、列高の最大/分散、天井高、凹凸、井戸の維持、B2B継続確率、T字受け基盤、I列温存、トゲ（露出スパイク）抑制 など。
- **初期重み例（要調整）**：
  - `w_kpi=1.0, w_holes=-4.0, w_coveredHoles=-6.0, w_b2b=0.6, w_bumpiness=-0.4, w_maxHeight=-0.3, w_tWell=0.5, w_iWell=0.3`
- タイブレーク：
  1) KPI期待値高 > 2) 穴少 > 3) B2B継続性高 > 4) 低い最大高。

### F-4. AI I/F（ゲーム↔AI）
- 観測（input）：
  - `board[22][10]`（隠し行含む）、`activePiece`、`holdPiece`、`next[5]`、`b2bFlag`、`comboCount`（参照のみ）、`seed`、`frameTimeBudgetMs`。
- 出力（output）：
  - `action`：`{piece, x, y, rotation, holdUsed}`（必要に応じて操作列 `moves[]`）。
  - `estimate`：`{kpiGain, features:{holes,...}}`（デバッグ用）。
- プロトコル：in-proc コール or WebWorker/MessageChannel（UI と分離可能）。
- 同期：**1ピース出現ごとに1回**決定。**再計算トリガ**：ライン消去時、HOLD実行時、NEXT変化時。移動・回転では再計算しない（パフォーマンス優先）。

### F-5. パフォーマンス要件
- 60fpsを維持。メインスレッドは **1フレームの処理上限 6ms** 目安。
- AI 計算は WebWorker などで分離、**1手あたり 10〜16ms** の制限を厳守（超過時は現時点最良案を返す）。

---

## G. テレメトリ／デバッグ（開発用）
- トグル機能：`showAIGhost`, `showEval`, `showHeights`, `showHoles`。
- ログ（任意）：`ai_decision.jsonl`（時刻、評価上位5案、選択理由）※本番ではOFF。

---

## H. 非機能要件
- 動作環境：最新 Chrome / Edge。
- 体感性能：**入力遅延 1フレーム以内**、AIゴーストの表示遅延 **1ピース以内**。
- 保守性：設定は `config.json` で集約。TypeScript 導入推奨。
- テスト：ユニット（SRSキック表、B2B、T-Spin 判定）、スナップショット（盤面→評価）を整備。

---

## I. 受け入れ条件（UAT）
1. **SRS 検証**：TSD/TST の全代表ケースで回転・キックが一致。
2. **ロック遅延**：連続リセット 15 回で強制ロック。ハードドロップは即ロック。
3. **DAS/ARR 体感**：133ms/10ms 設定時、長押しで連続移動が始まり、ARR 間隔が視認できる。
4. **KPI 計測**：300秒間のスコアが表の定義に一致（REN/PCは 0）。
5. **AI ゴースト**：プレイヤーゴーストと**座標完全一致**、オフセットは 0。HOLD 推奨場面では `holdUsed=true` の手が反映。
6. **60fps**：通常盤面でフレーム落ち無し。AIの 1手当たり時間制限を越えない。

---

## J. テスト計画（抜粋）
- **SRS キック表スイート**：各ピース×各姿勢×壁/地形接触の通過可否。
- **T-Spin 判定**：Mini/S/D/T の固定化パターン、B2B 継続の有無。
- **ロック遅延**：移動/回転/落下による Move Reset カウントの記録と 15回強制ロック。
- **KPI 回帰**：固定シナリオ（スクリプト操作）で期待KPIと一致。
- **AI 機能**：ホールド分岐の有無で解が変わる既知局面（例：I待ち vs TSD）。

---

## K. 実装構成（参考）
```
src/
  core/
    board.ts        # 盤面・行消去・B2B/コンボ
    srs.ts          # 回転・キック表
    gravity.ts      # 落下・DAS/ARR・ロック遅延
    kpi.ts          # スコア/KPI
  ai/
    search.ts       # ビームサーチ本体
    eval.ts         # 評価関数
    iface.ts        # 入出力I/F定義
  ui/
    renderer.tsx    # Canvas/DOM描画、AIゴーストレイヤ
    hud.tsx         # KPI/タイマ
    settings.tsx    # キー・DAS/ARR 設定
  config.json       # 可変パラメータ
```

---

## L. AIコーディングエージェント運用ポリシー
- **ガードレール**：
  - 先に **`iface.ts` と `config.json`** を固定 → 以降の修正を最小化。
  - 仕様差分は **TODO/OPEN** を明示し、小粒 PR 単位で解決。
- **推奨プロンプト手順**：
  1) 「`srs.ts` にガイドラインSRSのキック表を実装し、ユニットテストを生成して」
  2) 「`gravity.ts` に Move Reset/15回上限のロック遅延、DAS/ARR を入れて」
  3) 「`kpi.ts` にスコア表と300秒計測ウィンドウを実装、テストも」
  4) 「`ai/search.ts` に幅N=200 深さ2〜3のビームサーチ、時間打切りを追加」
  5) 「`ui/renderer.tsx` に AI ゴーストを重ね描画。座標オフセット 0 を保証するテスト追加」
- **レビューチェック**：
  - 変更が `config.json` のパラメータだけで調整可能か？
  - UAT 項目に観測可能な形で紐づいているか？

---

## M. リスク・制約・チューニング
- PPT2 の厳密パラメータ非公開 → 体感較正を行う（ユーザ設定で微調整）。
- 評価関数の重みは初期値で妥当とは限らない → **固定盤面回帰テスト**で比較可能に。
- Web と AI のスレッド境界 → WebWorker で切り離し、メッセージサイズを最小化（差分送信も検討）。

---

## N. 用語
- **DAS/ARR**：長押し開始までの遅延／連続移動の間隔。
- **Move Reset**：移動や回転等でロック遅延を再スタートする方式。
- **B2B**：Tetris/T-Spin 系の連続成立によるボーナス継続。

---

## O. ToDo / OPEN（要確認事項）
1. 重力とソフトドロップ倍率の**最終値**（PPT2 近似の体感較正範囲）。
2. B2B の**継続定義の境界**（無消去T-Spin扱い、無効化条件）。
3. T-Spin 判定の**採用基準**（ガイドライン準拠の角当たり判定の細目）。
4. ホールド時の**バッグ進行仕様**（現行＝標準想定、念のため明文化）。
5. AI の**評価重み初期値**と、調整 UI の有無。
6. AI の**時間予算**（固定値か、盤面難易度で伸縮させるか）。
7. **入力ポーリング周期**と**フレーム処理順序**（入力→物理→衝突→ロック→描画）。
8. **キーバインドUI**の詳細（アクセシビリティ、同時押し、長押ししきい値）。
9. **テストカバレッジ目標**（SRS・ロック・KPI・AI それぞれの基準）。
10. 将来互換のための **リプレイフォーマット**最小仕様（今回は非対応／設計だけ残す？）。

---

## 付録A：`config.json` 初期値例
```json
{
  "gravityCPS": 5.0,
  "softDropMultiplier": 20.0,
  "dasMs": 133,
  "arrMs": 10,
  "lockDelayMs": 500,
  "lockResetsMax": 15,
  "lockResetTriggers": ["move", "rotate"],
  "nextCount": 5,
  "useARE": false,
  "lineClearDelayMs": 50,
  "beamWidth": 200,
  "beamDepth": 3,
  "timeBudgetMs": 12,
  "aiRecalcTriggers": ["lineClear", "hold", "nextChange"],
  "b2bCountMini": true
}
```json
{
  "gravityCPS": 5.0,
  "softDropCPS": 20.0,
  "dasMs": 133,
  "arrMs": 10,
  "lockDelayMs": 500,
  "lockResetsMax": 15,
  "nextCount": 5,
  "useARE": false,
  "lineClearDelayMs": 0,
  "beamWidth": 200,
  "beamDepth": 3,
  "timeBudgetMs": 12
}
```

## 付録B：AI I/F 型定義例（TypeScript）
```ts
export interface Observation {
  board: number[][]; // 22x10, 0/1 or color id
  active: Piece;      // type, rot, x, y
  hold: Piece | null;
  next: PieceType[];  // length=5
  b2b: boolean;
  combo: number;
  seed: number;
  budgetMs: number;   // time budget
}

export interface Action {
  piece: PieceType;
  x: number; y: number; rot: number; // final placement
  holdUsed: boolean;
  moves?: ("L"|"R"|"SD"|"HD"|"CW"|"CCW")[]; // optional
}
```

